<html>
<!--
 This file is part of the Java Settlers Web App.

 This file Copyright (C) 2017 Jeremy D Monin (jeremy@nand.net)

 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with this program.  If not, see http://www.gnu.org/licenses/ .

 -->

<head>
  <title>JSettlers-WebApp Server Demo</title>
  <meta charset="UTF-8">
</head>
<body>

<H3>JSettlers Web App Server - WebSocket Chat Demo</H3>

<div id="login_form">
  <form name="login" action="javascript:submitLogin()">
    <label for="nick"><B>Nickname:</B></label>
    <input name="nick" size=20 />
     &nbsp; &nbsp;
    <button type="submit" name="conn">Connect</button>
  </form>
</div>

<div id="chat_form">
  <HR noshade />

  <form name="send" action="javascript:sendLine()">
    <input name="txt" size=60 />
     &nbsp; &nbsp;
    <button type="submit">Send</button>
  </form>
</div>

<div id="messagesArea" />

<script>

nickname = null;
wsConn = null;
messagesArea = document.getElementById("messagesArea");

function submitLogin()
{
    if (wsConn != null)
	return true;

    var nick = document.forms.login.nick.value.trim();
    if (0 == nick.length)
    {
	alert("Please enter a nickname.");
	return true;
    }

    nickname = nick;

    var wsProto = (window.location.protocol == "https:") ? "wss://" : "ws://";
    var wsURL = wsProto + window.location.host + window.location.pathname;
    if (wsURL.charAt(wsURL.length - 1) != "/")
        wsURL += "/";
    wsURL += "apisock";
    showMessage("Conecting to " + wsURL);

    wsConn = new WebSocket(wsURL);

    wsConn.onopen = function(event)
    {
	console.log("at onOpen");
	if (event.data === undefined)
	    return;

	showMessage(event.data);  // server's initial reply
	document.forms.login.conn.disabled = true;
	document.forms.send.txt.focus();
    }

    wsConn.onmessage = function(event)
    {
	showMessage(event.data);
    }

    wsConn.onclose = function(closeEvent)
    {
	wsConn = null;
	showMessage("Disconnected.");
	console.log("at onClose. Code " + closeEvent.code + " reason " + closeEvent.reason);
    }

    wsConn.onerror = function(event)
    {
	showMessage("Websocket received error.");
    }
}

function sendLine(frm)
{
    var txfield = document.forms.send.txt;
    var txt = txfield.value.trim();
    if (0 == txt.length)
	return true;
    if (wsConn == null)
    {
	alert("Not connected.");
	return true;
    }

    txfield.value = "";
    wsConn.send(nickname + ": " + txt);
}

function showMessage(txt)
{
    messagesArea.appendChild(document.createTextNode(txt));
    messagesArea.appendChild(document.createElement("br"));
}


</script>

</body></html>
