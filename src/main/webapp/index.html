<html>
<!--
 This file is part of the Java Settlers Web App.

 This file Copyright (C) 2017 Jeremy D Monin (jeremy@nand.net)

 Open-source license: TBD
 -->

<head>
  <title>JSettlers-WebApp Demo</title>
  <meta charset="UTF-8">
  <script src="inc/jquery-3.2.1.min.js"></script>
</head>
<body>

<H3>JSettlers Web App</H3>

<div id="login_form">
  <form name="login" onsubmit="event.preventDefault(); doLogin(); return false;">
    <label for="nick"><B>Nickname:</B></label>
    <input name="nick" size=20 />
    &nbsp; &nbsp;
    <button name="connect" type="submit">Connect</button>
    to <span id="connURL"></span>
  </form>
</div>

<HR noshade>

<div id="connected_div" style="display:none">
  Connected

  <HR noshade>
</div>

TBD here

<script>

nickname = null;  // demo user's nickname (login account)
wsURL = null;  // websocket url to connect to, calculated and displayed in init()
wsConn = null;  // websocket, after doConnect()
hasFirstMessage = false;  // true at first message received from server

// jquery setup
$(function(){
   initPage();
});

function initPage()
{
    var wsProto = (window.location.protocol == "https:") ? "wss://" : "ws://";
    wsURL = wsProto + window.location.host + "/socserver/apisock"
    document.getElementById("connURL").innerHTML = wsURL;
}

function atFirstMessage(wsEvent)
{
    console.log("L57 atFirstMsg");
    $("#connected_div").show();
    document.forms.login.connect.disabled = true;

    // send our version
    // TODO get an actual locale
    var versMsg = { "vers": { "versNum": 3000, "versStr": "3.0.00", "versBuild": "WS20171124", "cliLocale": "en_US" } };
    wsConn.send(JSON.stringify(versMsg));
}

function doLogin()
{
    if (wsConn != null)
	return;

    var nick = document.forms.login.nick.value.trim();
    if (0 == nick.length)
    {
	alert("Please enter a nickname.");
	return;
    }

    nickname = nick;

    console.log("Conecting to " + wsURL);

    wsConn = new WebSocket(wsURL);

    wsConn.onopen = function(event)
    {
	console.log("ws onOpen");
    }

    wsConn.onmessage = function(event)
    {
	if (! hasFirstMessage)
	{
	    hasFirstMessage = true;
	    atFirstMessage(event);
	}
	showMessage(event.data);
    }

    wsConn.onclose = function(closeEvent)
    {
	wsConn = null;
	showMessage("Disconnected.");
	console.log("ws onClose. Code " + closeEvent.code + " reason " + closeEvent.reason);
    }

    wsConn.onerror = function(event)
    {
	showMessage("Websocket received error.");
    }
}

function showMessage(txt)
{
    // this is temporary
    alert("Msg: " + txt);
}

</script>

</body></html>
