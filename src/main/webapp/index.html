<html>
<!--
 This file is part of the Java Settlers Web App.

 This file Copyright (C) 2017 Jeremy D Monin (jeremy@nand.net)

 Open-source license: TBD
 -->

<head>
  <title>JSettlers-WebApp Demo</title>
  <meta charset="UTF-8">
  <script src="inc/jquery-3.2.1.min.js"></script>
  <link rel="stylesheet" type="text/css" href="index.css">
</head>
<body>

<H3>JSettlers Web App</H3>

<div id="login_form">
  <form name="login" onsubmit="event.preventDefault(); doLogin(); return false;">
    <label for="nick"><B>Nickname:</B></label>
    <input name="nick" size=20 />
    &nbsp; &nbsp;
    <button name="connect" type="submit">Connect</button>
    to <span id="connURL"></span>
  </form>
</div>

<HR noshade>

<div id="connected_div" style="display:none">
  Connected

  <HR noshade>

  <table border=0>
    <tr valign="top">
      <td style="padding-right: 24px;">
	<!-- TODO what if server doesn't support chat feature? -->
        <div id="chat_channel_list" class="actives">Chat Channels:<BR/></div>
      </td>
      <td>
        <div id="game_list" class="actives">Current Games:<BR/></div>
      </td>
  </table>

</div>



<script>

nickname = null;  // demo user's nickname (login account)
wsURL = null;  // websocket url to connect to, calculated and displayed in init()
wsConn = null;  // websocket, after doConnect()
hasFirstMessage = false;  // true at first message received from server

// jquery setup
$(function(){
   initPage();
});

function initPage()
{
    var wsProto = (window.location.protocol == "https:") ? "wss://" : "ws://";
    wsURL = wsProto + window.location.host + "/socserver/apisock"
    document.getElementById("connURL").innerHTML = wsURL;
}

// WebSocket callbacks; login button //

function atFirstMessage(wsEvent)
{
    $("#connected_div").show();
    document.forms.login.connect.disabled = true;

    // send our version
    // TODO get an actual locale
    var versMsg = { "vers": { "versNum": 3000, "versStr": "3.0.00", "versBuild": "WS20171124", "cliLocale": "en_US" } };
    wsConn.send(JSON.stringify(versMsg));
}

function doLogin()
{
    if (wsConn != null)
	return;

    var nick = document.forms.login.nick.value.trim();
    if (0 == nick.length)
    {
	alert("Please enter a nickname.");
	return;
    }

    nickname = nick;

    console.log("Conecting to " + wsURL);

    wsConn = new WebSocket(wsURL);

    wsConn.onopen = function(event)
    {
	console.log("ws onOpen");
    }

    wsConn.onmessage = function(event)
    {
	if (! hasFirstMessage)
	{
	    hasFirstMessage = true;
	    atFirstMessage(event);
	}
	showMessage(event.data);
        var msgObj = null;
	try
	{
	    msgObj = JSON.parse(event.data);
	    var mkeys = Object.keys(msgObj);
	    if (mkeys.length != 1)
	    {
		console.log("(malformed: keys)");
		msgObj = null;
	    }
	} catch(e) {
	    console.log("(malformed: parser)");
	}

	if (msgObj != null)
	    try
	    {
		msgDispatch(mkeys[0], msgObj[mkeys[0]]);
	    } catch(e) {
		console.log("dispatch error: " + e);
	    }
    }

    wsConn.onclose = function(closeEvent)
    {
	wsConn = null;
	alert("Disconnected.");
	console.log("ws onClose. Code " + closeEvent.code + " reason " + closeEvent.reason);
    }

    wsConn.onerror = function(event)
    {
	alert("Websocket received error.");
    }
}

function showMessage(jsonTxt)
{
    // this is temporary until we have a message dispatcher
    console.log("From server: " + jsonTxt);
}

// TODO separate include file

dispatchTo =
{
    channels: function(mData)
    {
	if (mData.names)
	    listPopulate('chat_channel_list', mData.names);
    },
    games: function(mData)
    {
	if (mData.game)
	{
	    var gaNames = [];
	    mData.game.forEach(function(gaObj, i) { gaNames[i] = gaObj.gaName; } );
	    listPopulate('game_list', gaNames);
	}
    },
    chNew: function(mData)
    {
	listAdd('chat_channel_list', mData.chName);
    },
    chDelete: function(mData)
    {
	listRemove('chat_channel_list', mData.chName);
    },
};

function msgDispatch(mType, mData)
{
    console.log("type for dispatch: " + mType);
    console.log("    mData is: " + JSON.stringify(mData));
    var dfunc = dispatchTo[mType];
    if (dfunc)
	dfunc(mData);
}

// UI //

/* chat channel list, game list */

function alphaCompareStrings(a,b)
{
    return a.toLocaleUpperCase().localeCompare(b.toLocaleUpperCase());
}

function alphaCompareElems(a, b)
{
    return $(a).text().toLocaleUpperCase().localeCompare($(b).text().toLocaleUpperCase());
}

// populate alphabetical chat_channel_list or game_list from itemNames string array
function listPopulate(listId, itemNames)
{
    if (! itemNames)
	return;  // empty, undefined, null

    itemNames.sort(alphaCompareStrings);
    var newUL = $('<ul />', {'class': 'actives', 'style': "padding-left: 0;" });  // must force 0 padding here too
    $.each(itemNames, function(i)
    {
	var li = $('<li />').text(itemNames[i]).appendTo(newUL);
    });
    $('#' + listId).append(newUL);
}

// add itemName to chat_channel_list or game_list alphabetically
function listAdd(listId, itemName)
{
    var newLI = $('<li />').text(itemName);
    var UL = $('#' + listId + ' ul');
    if (UL.length)
    {
	newLI.hide();
	$('li', '#' + listId + ' ul').add(newLI.fadeIn(700)).sort(alphaCompareElems).appendTo(UL);
    } else {
	// is first channel or game: no list yet
        var newUL = $('<ul />', {'class': 'actives', 'style': "padding-left: 0;" });
	newLI.fadeIn(700).appendTo(newUL);
	$('#' + listId).append(newUL);
    }
}

function listRemove(listId, itemName)
{
    var ul = $('#' + listId + ' ul');
    if (! ul.length)
	return;
    var li = ul.find(':contains(' + itemName + ')');
    if (! li.length)
	return;
    li.fadeOut(700, function(){ $(this).remove(); });
}


</script>

</body></html>
